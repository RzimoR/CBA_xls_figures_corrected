<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Economic Evaluation of Investment Alternatives</title>
    <link rel="icon" type="image/png" href="isgan_logo.png">
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f6f6f8;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 1100px;
            margin: 30px auto 0 auto;
            background: #fff;
            border-radius: 14px;
            box-shadow: 0 2px 16px rgba(0,0,0,0.09);
            padding: 30px 40px 50px 40px;
            position: relative;
        }
        h1 {
            text-align: center;
            color: #1a237e;
            margin-bottom: 0;
        }
        .logo {
            display: block;
            margin: 0 auto 12px auto;
            width: 180px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 18px;
            background: #fff;
        }
        th, td {
            border: 1px solid #bdbdbd;
            padding: 7px 10px;
            text-align: center;
        }
        th {
            background: #e3e6f3;
        }
        .highlight-npv {
            background-color: #ffe066 !important;
            font-weight: bold;
        }
        .btn {
            background: #3949ab;
            color: #fff;
            border: none;
            padding: 8px 18px;
            margin: 12px 8px 0 0;
            cursor: pointer;
            border-radius: 4px;
            font-size: 15px;
        }
        .btn:hover {
            background: #1a237e;
        }
        .footer {
            text-align: center;
            margin-top: 40px;
            color: #888;
            font-size: 15px;
        }
        @media (max-width: 700px) {
            .container {
                padding: 10px 2vw 30px 2vw;
            }
            table, th, td {
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <img src="isgan_logo.png" alt="ISGAN Logo" class="logo">
    <h1>Economic Evaluation of Investment Alternatives</h1>
    <form id="cba-form">
        <table>
            <thead>
            <tr>
                <th>Name</th>
                <th>CAPEX</th>
                <th>OPEX</th>
                <th>Benefits</th>
                <th>Years</th>
                <th>Discount Rate (%)</th>
            </tr>
            </thead>
            <tbody id="input-rows">
            <!-- Input rows generated by JS -->
            </tbody>
        </table>
        <button type="button" class="btn" onclick="calculateCBA()">Calculate CBA</button>
        <button type="button" class="btn" onclick="resetForm()">Reset CBA</button>
        <a href="https://smartgrideval.unica.it/main_cba/" class="btn" style="background:#bdbdbd;color:#222;">Back to Smartgrideval</a>
        <button type="button" class="btn" onclick="downloadExcel()">Download Excel</button>
    </form>
    <div id="results-section" style="display:none;">
        <h2 style="text-align:center;margin-top:30px;">Results</h2>
        <table id="results-table">
            <thead>
            <tr>
                <th>Name</th>
                <th>CAPEX</th>
                <th>OPEX</th>
                <th>Benefits</th>
                <th>Years</th>
                <th>Rate (%)</th>
                <th>NPV</th>
                <th>IRR</th>
                <th>CBR</th>
            </tr>
            </thead>
            <tbody>
            <!-- Results go here -->
            </tbody>
        </table>
    </div>
</div>
<div class="footer">
    &copy; 2024 ISGAN | CBA Tool
</div>
<script>
    const MAX_ROWS = 6;

    // Genera le righe di input
    function generateInputRows() {
        const tbody = document.getElementById('input-rows');
        tbody.innerHTML = '';
        for (let i = 0; i < MAX_ROWS; i++) {
            const tr = document.createElement('tr');
            tr.className = 'input-row';
            tr.innerHTML = `
                <td><input type="text" name="name" placeholder="Alternative ${i+1}" autocomplete="off"></td>
                <td><input type="number" name="capex" step="0.01" min="0"></td>
                <td><input type="number" name="opex" step="0.01" min="0"></td>
                <td><input type="number" name="benefits" step="0.01" min="0"></td>
                <td><input type="number" name="years" step="1" min="1"></td>
                <td><input type="number" name="rate" step="0.01" min="0"></td>
            `;
            tbody.appendChild(tr);
        }
    }

    // Reset form
    function resetForm() {
        generateInputRows();
        document.getElementById('results-section').style.display = 'none';
    }

    // Calcola CBA
    async function calculateCBA() {
        const rows = document.querySelectorAll('#input-rows tr');
        const data = [];
        rows.forEach(row => {
            const inputs = row.querySelectorAll('input');
            // Prendi solo le righe dove almeno un campo è compilato
            const isAnyFilled = Array.from(inputs).some(input => input.value.trim() !== "");
            if (!isAnyFilled) return; // salta le righe completamente vuote

            // Prendi solo le righe con tutti i campi compilati
            const name = inputs[0].value.trim();
            const capex = parseFloat(inputs[1].value);
            const opex = parseFloat(inputs[2].value);
            const benefits = parseFloat(inputs[3].value);
            const years = parseInt(inputs[4].value);
            const rate = parseFloat(inputs[5].value);

            if (
                name &&
                !isNaN(capex) &&
                !isNaN(opex) &&
                !isNaN(benefits) &&
                !isNaN(years) &&
                !isNaN(rate)
            ) {
                data.push({ name, capex, opex, benefits, years, rate });
            }
        });

        // Se non c'è almeno una alternativa completa
        if (data.length === 0) {
            alert('Please enter at least one complete alternative.');
            return;
        }

        // Chiamata API backend
        const response = await fetch('/calculate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const results = await response.json();
        showResults(results);
    }

    // Mostra risultati e evidenzia NPV massimo
    function showResults(results) {
        const tbody = document.querySelector('#results-table tbody');
        tbody.innerHTML = '';
        // Trova il NPV massimo tra le alternative valide
        let maxNPV = -Infinity;
        results.forEach(r => {
            if (typeof r.npv === 'number' && r.npv > maxNPV) maxNPV = r.npv;
        });

        results.forEach(r => {
            const tr = document.createElement('tr');
            if (r.npv === maxNPV && typeof r.npv === 'number') tr.classList.add('highlight-npv');
            tr.innerHTML = r.error ?
                `<td colspan="9" style="color:red;">${r.name}: ${r.error}</td>` :
                `<td>${r.name}</td>
                 <td>${r.capex}</td>
                 <td>${r.opex}</td>
                 <td>${r.benefits}</td>
                 <td>${r.years}</td>
                 <td>${r.rate}</td>
                 <td>${r.npv}</td>
                 <td>${r.irr}</td>
                 <td>${r.cbr}</td>`;
            tbody.appendChild(tr);
        });
        document.getElementById('results-section').style.display = '';
    }

    // Download Excel (preserva la tua funzione)
    function downloadExcel() {
        fetch('/download', { method: 'GET' })
            .then(response => response.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = "CBA_results.xlsx";
                document.body.appendChild(a);
                a.click();
                a.remove();
            });
    }

    // Init
    generateInputRows();
</script>
</body>
</html>

