<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CBA Calculator</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <div class="container mt-4">
    <h1>Cost-Benefit Analysis</h1>
    <form id="calcForm">
      <div class="mb-3">
        <label for="name" class="form-label">Nome progetto</label>
        <input type="text" class="form-control" id="name" name="name" required>
      </div>
      <div class="mb-3">
        <label for="capex" class="form-label">CAPEX</label>
        <input type="number" class="form-control" id="capex" name="capex" step="0.01" required>
      </div>
      <div class="mb-3">
        <label for="opex" class="form-label">OPEX</label>
        <input type="number" class="form-control" id="opex" name="opex" step="0.01" required>
      </div>
      <div class="mb-3">
        <label for="benefits" class="form-label">Benefici</label>
        <input type="number" class="form-control" id="benefits" name="benefits" step="0.01" required>
      </div>
      <div class="mb-3">
        <label for="years" class="form-label">Anni</label>
        <input type="number" class="form-control" id="years" name="years" required>
      </div>
      <div class="mb-3">
        <label for="rate" class="form-label">Rate (%)</label>
        <input type="number" class="form-control" id="rate" name="rate" step="0.01" required>
      </div>
      <button type="submit" class="btn btn-primary">Calcola CBA</button>
    </form>
    <div id="results" class="mt-4"></div>
    <div class="row mt-4">
      <div class="col">
        <canvas id="npvChart"></canvas>
      </div>
      <div class="col">
        <canvas id="irrChart"></canvas>
      </div>
      <div class="col">
        <canvas id="cbrChart"></canvas>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    document.getElementById("calcForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData.entries());
      try {
        const res = await axios.post("/calculate", data);
        const results = res.data;

        // Calcola il massimo NPV
        const maxNPV = Math.max(...results.map(r => r.npv));

        // Costruisci la tabella dei risultati
        let html = `
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Nome</th><th>CAPEX</th><th>OPEX</th><th>Benefici</th>
                <th>Anni</th><th>Rate</th><th>NPV</th><th>IRR</th><th>CBR</th>
              </tr>
            </thead>
            <tbody>`;
        results.forEach(r => {
          const isBest = Math.abs(r.npv - maxNPV) < 1e-6;
          html += `
            <tr${isBest ? ' class="table-success"' : ''}>
              <td>${r.name}</td>
              <td>${r.capex}</td>
              <td>${r.opex}</td>
              <td>${r.benefits}</td>
              <td>${r.years}</td>
              <td>${r.rate}</td>
              <td>${r.npv}</td>
              <td>${r.irr}</td>
              <td>${r.cbr}</td>
            </tr>`;
        });
        html += `
            </tbody>
          </table>
          <button class="btn btn-success" onclick="downloadExcel()">
            Scarica Excel
          </button>`;
        document.getElementById("results").innerHTML = html;

        // Disegna i grafici
        const labels = results.map(r => r.name);
        new Chart(document.getElementById("npvChart"), {
          type: 'bar',
          data: { labels, datasets: [{ label: 'NPV', data: results.map(r => r.npv) }] },
          options: {}
        });
        new Chart(document.getElementById("irrChart"), {
          type: 'bar',
          data: { labels, datasets: [{ label: 'IRR', data: results.map(r => r.irr) }] },
          options: {}
        });
        new Chart(document.getElementById("cbrChart"), {
          type: 'bar',
          data: { labels, datasets: [{ label: 'CBR', data: results.map(r => r.cbr) }] },
          options: {}
        });
      } catch (err) {
        document.getElementById("results").innerHTML =
          "<p class='text-danger'>Errore nel calcolo.</p>";
      }
    });

    function downloadExcel() {
      window.location.href = '/download';
    }
  </script>
</body>
</html>
